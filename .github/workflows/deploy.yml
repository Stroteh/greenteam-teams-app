name: Deploy GreenTeam to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    # 1. Checkout koda
    - name: Checkout repository
      uses: actions/checkout@v4
    
    # 2. Preveri osnovne datoteke
    - name: Check basic files
      run: |
        echo "ðŸ“ Checking repository structure..."
        ls -la
        
        # Popravi firebase-service.js Äe ima napake
        if [ -f "firebase-service.js" ]; then
          echo "ðŸ”§ Checking firebase-service.js..."
          # Odstrani podvojene razliÄice
          # Lahko dodate popravke tukaj ali pa preprosto nadomestite s popravljeno razliÄico
          if grep -q "// firebase-service.js - Nadgrajena razliÄica" firebase-service.js && grep -q "// firebase-service.js - Firebase storitev" firebase-service.js; then
            echo "âš ï¸ Firebase-service has duplicate code, using backup..."
            echo '// Placeholder - will be replaced during deployment' > firebase-service.js
          fi
        fi
    
    # 3. Ustvari manjkajoÄe JavaScript datoteke
    - name: Create missing JS files
      run: |
        echo "ðŸ”§ Creating missing files..."
        
        # Ustvari teams-integration.js
        if [ ! -f "teams-integration.js" ]; then
          cat > teams-integration.js << 'EOF'
// teams-integration.js - placeholder
console.log('Teams integration loaded');
const teamsIntegration = { 
  initialize: async () => {
    console.log(" Teams integration initialized (placeholder)");
    return false;
  },
  getContextForFirebase: () => null,
  currentUser: { id: 'local_user', name: 'Local User', initials: 'LU' },
  members: []
};
EOF
        fi
        
        # Ustvarite firebase-config.js iz secretov ALI placeholder
        cat > firebase-config.js << 'EOF'
// Firebase Configuration
window.firebaseConfig = {
  apiKey: "${{ secrets.FIREBASE_API_KEY || 'demo-key' }}",
  authDomain: "${{ secrets.FIREBASE_AUTH_DOMAIN || 'demo.firebaseapp.com' }}",
  projectId: "${{ secrets.FIREBASE_PROJECT_ID || 'demo-project' }}",
  storageBucket: "${{ secrets.FIREBASE_STORAGE_BUCKET || 'demo.appspot.com' }}",
  messagingSenderId: "${{ secrets.FIREBASE_SENDER_ID || '123456' }}",
  appId: "${{ secrets.FIREBASE_APP_ID || '1:123:web:abc' }}"
};

console.log("Firebase config loaded");
EOF
        
        # Ustvari funkcije.js placeholder
        if [ ! -f "funkcije.js" ]; then
          cat > funkcije.js << 'EOF'
// funkcije.js - placeholder
console.log('Main functions loaded');

// Osnovne funkcije
function setupEventListeners() {
  console.log("Setting up event listeners");
}

function setupNavigation() {
  console.log("Setting up navigation");
}

async function initializeApp() {
  console.log("Initializing app...");
  // Osnovna inicializacija
  setupEventListeners();
  setupNavigation();
  
  // PrikaÅ¾i aplikacijo
  document.querySelector('.app-container').style.display = 'block';
}

document.addEventListener('DOMContentLoaded', initializeApp);
EOF
        fi
        
        # Ustvari firebase-service.js Äe ne obstaja ali je pokvarjen
        if [ ! -f "firebase-service.js" ] || [ $(wc -l < firebase-service.js) -lt 50 ]; then
          echo "ðŸ“¦ Creating minimal firebase-service.js..."
          cat > firebase-service.js << 'EOF'
class FirebaseService {
  constructor() {
    this.db = null;
    this.isInitialized = false;
    this.currentTeamId = 'personal';
    this.currentUserId = `user_${Date.now()}`;
  }

  async initialize() {
    console.log("Firebase service placeholder - running in offline mode");
    this.isInitialized = true;
    return true;
  }

  async saveTask(task) {
    console.log("Saving task (offline):", task.title);
    return true;
  }

  subscribeToTasks(callback) {
    console.log("Task subscription (offline)");
    // Vrnite prazno array za zdaj
    setTimeout(() => callback([]), 100);
  }

  getStatus() {
    return { isInitialized: this.isInitialized };
  }
}

const firebaseService = new FirebaseService();
EOF
        fi
    
    # 4. Ustvari manifest mapo
    - name: Create manifest directory
      run: |
        mkdir -p manifest
        # Ustvari preprost manifest.json
        cat > manifest/manifest.json << 'EOF'
{
  "name": "GreenTeam",
  "short_name": "GreenTeam",
  "description": "Kanban and Calendar app for Teams",
  "start_url": ".",
  "display": "standalone",
  "background_color": "#00a76d",
  "theme_color": "#00a76d",
  "icons": []
}
EOF
    
    # 5. Deploy na GitHub Pages
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        force_orphan: false
        keep_files: true
    
    # 6. Success
    - name: Success
      run: |
        echo "ðŸŽ‰ Deployment successful!"
        echo "ðŸŒ Your app is available at:"
        echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
