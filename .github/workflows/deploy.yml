name: Deploy GreenTeam to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout koda
    - name: Checkout repository
      uses: actions/checkout@v4
    
    # 2. Setup Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    # 3. List files for debugging
    - name: Debug - List files
      run: |
        echo "üìÅ Repository structure:"
        ls -la
        echo ""
        echo "üìÇ Files in root:"
        find . -maxdepth 1 -type f -name "*.*" | sort
    
    # 4. Preveri potrebne datoteke
    - name: Check required files
      run: |
        echo "üîç Checking required files..."
        required_files=("index.html" "style.css" "firebase-service.js" "funkcije.js")
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "‚úÖ $file exists"
          else
            echo "‚ùå $file is missing!"
            exit 1
          fi
        done
    
    # 5. Kreiraj teams-integration.js ƒçe ne obstaja
    - name: Check or create teams-integration.js
      run: |
        echo "üë• Checking teams-integration.js..."
        if [ ! -f "teams-integration.js" ]; then
          echo "üìù Creating teams-integration.js..."
          cat > teams-integration.js << 'EOF'
// teams-integration.js - Besplatna Teams integracija brez Azure

class TeamsIntegration {
    constructor() {
        this.isInitialized = false;
        this.context = null;
        this.members = [];
        console.log("üë• TeamsIntegration kreiran");
    }

    async initialize() {
        try {
            console.log("üöÄ Inicializiram Teams...");
            
            if (typeof microsoftTeams === 'undefined') {
                console.warn("‚ö†Ô∏è Teams SDK ni na voljo");
                return false;
            }
            
            await microsoftTeams.app.initialize();
            
            // Pridobi Teams kontekst
            this.context = await microsoftTeams.app.getContext();
            console.log("‚úÖ Teams kontekst pridobljen:", this.context);
            
            // Obdelaj kontekst
            this.processContext();
            
            this.isInitialized = true;
            return true;
            
        } catch (error) {
            console.error("‚ùå Napaka pri inicializaciji Teams:", error);
            return false;
        }
    }

    processContext() {
        if (!this.context) return;
        
        const user = this.context.user || {};
        const team = this.context.team || {};
        
        // Ustvari na≈° format uporabnika
        this.currentUser = {
            id: user.id || `teams_${Date.now()}`,
            name: user.displayName || 'Teams Uporabnik',
            email: user.userPrincipalName || '',
            initials: this.getInitials(user.displayName || 'TU'),
            teamsId: user.id,
            tenantId: user.tenantId,
            isTeamsUser: true,
            photoUrl: user.photoUrl,
            teamId: team.id || 'personal',
            teamName: team.displayName || 'Personal'
        };
        
        console.log("üë§ Trenutni uporabnik:", this.currentUser.name);
        
        // Samo trenutni uporabnik za zaƒçetek
        this.members = [this.currentUser];
    }

    getInitials(name) {
        return name.split(' ')
            .map(part => part[0])
            .join('')
            .toUpperCase()
            .substring(0, 2) || 'TU';
    }

    async getContextForFirebase() {
        return {
            user: this.currentUser,
            team: {
                id: this.currentUser.teamId,
                name: this.currentUser.teamName
            }
        };
    }

    // Roƒçno dodajanje ƒçlanov
    async addMemberManually(memberData) {
        try {
            const newMember = {
                id: `manual_${Date.now()}`,
                name: memberData.name,
                email: memberData.email || '',
                initials: this.getInitials(memberData.name),
                isTeamsUser: false,
                isManual: true,
                addedBy: this.currentUser.id,
                addedAt: new Date().toISOString(),
                teamId: this.currentUser.teamId
            };
            
            this.members.push(newMember);
            console.log("‚úÖ Roƒçno dodan ƒçlan:", newMember.name);
            return newMember;
            
        } catch (error) {
            console.error("‚ùå Napaka pri dodajanju ƒçlana:", error);
            throw error;
        }
    }

    // Preveri dovoljenja
    checkPermissions() {
        return {
            canAccessTeams: this.isInitialized,
            hasTeam: !!this.currentUser?.teamId && this.currentUser.teamId !== 'personal',
            user: this.currentUser
        };
    }

    // Prika≈æi obvestilo v Teams
    showNotification(message, title = 'GreenTeam') {
        if (!this.isInitialized) return;
        
        try {
            microsoftTeams.tasks.submitTask({
                title: title,
                message: message
            });
        } catch (error) {
            console.warn("Ne morem prikazati Teams obvestila:", error);
        }
    }
}

// Globalna instanca
const teamsIntegration = new TeamsIntegration();
EOF
          echo "‚úÖ teams-integration.js ustvarjen"
        else
          echo "‚úÖ teams-integration.js ≈æe obstaja"
        fi
    
    # 6. Kreiraj Firebase config datoteko
    - name: Generate Firebase Configuration
      run: |
        echo "üöÄ Generating firebase-config.js..."
        
        echo "// ============================================" > firebase-config.js
        echo "// FIREBASE CONFIGURATION" >> firebase-config.js
        echo "// Auto-generated by GitHub Actions" >> firebase-config.js
        echo "// ============================================" >> firebase-config.js
        echo "" >> firebase-config.js
        echo "window.firebaseConfig = {" >> firebase-config.js
        echo "  apiKey: '${{ secrets.FIREBASE_API_KEY }}'," >> firebase-config.js
        echo "  authDomain: '${{ secrets.FIREBASE_AUTH_DOMAIN }}'," >> firebase-config.js
        echo "  projectId: '${{ secrets.FIREBASE_PROJECT_ID }}'," >> firebase-config.js
        echo "  storageBucket: '${{ secrets.FIREBASE_STORAGE_BUCKET }}'," >> firebase-config.js
        echo "  messagingSenderId: '${{ secrets.FIREBASE_SENDER_ID }}'," >> firebase-config.js
        echo "  appId: '${{ secrets.FIREBASE_APP_ID }}'" >> firebase-config.js
        echo "};" >> firebase-config.js
        echo "" >> firebase-config.js
        echo "console.log('üî• Firebase configuration loaded from GitHub Actions');" >> firebase-config.js
        
        echo "‚úÖ firebase-config.js created"
        echo "üìÑ First few lines:"
        head -10 firebase-config.js
    
    # 7. Preveri/ustvari manifest folder
    - name: Check or create manifest
      run: |
        echo "üìÅ Preverjam manifest mapo..."
        
        if [ -d "manifest" ]; then
          echo "‚úÖ Manifest mapa obstaja"
        else
          echo "üìù Ustvarjam manifest mapo..."
          mkdir -p manifest
        fi
        
        # Preveri ali ikone obstajajo, ƒçe ne jih prenesi
        if [ ! -f "manifest/icon-color.png" ]; then
          echo "üé® Prenasljam barvno ikono..."
          wget -q -O manifest/icon-color.png "https://via.placeholder.com/192/00a76d/FFFFFF?text=GT" || echo "‚ö†Ô∏è Ne morem prenesti ikone"
        fi
        
        if [ ! -f "manifest/icon-outline.png" ]; then
          echo "üé® Prenasljam obrisno ikono..."
          wget -q -O manifest/icon-outline.png "https://via.placeholder.com/32/00a76d/FFFFFF?text=GT" || echo "‚ö†Ô∏è Ne morem prenesti ikone"
        fi
        
        # Ustvari manifest.json
        echo "üìù Ustvarjam manifest.json..."
        
        # Uporabimo GitHub environment variables
        REPO_OWNER='${{ github.repository_owner }}'
        REPO_NAME='${{ github.event.repository.name }}'
        APP_URL="https://${REPO_OWNER}.github.io/${REPO_NAME}"
        
        echo "{" > manifest/manifest.json
        echo '  "$schema": "https://developer.microsoft.com/en-us/json-schemas/teams/v1.16/MicrosoftTeams.schema.json",' >> manifest/manifest.json
        echo '  "manifestVersion": "1.16",' >> manifest/manifest.json
        echo '  "version": "1.0.0",' >> manifest/manifest.json
        echo '  "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",' >> manifest/manifest.json
        echo '  "packageName": "com.greenteam.kanban",' >> manifest/manifest.json
        echo '  "developer": {' >> manifest/manifest.json
        echo '    "name": "GreenTeam",' >> manifest/manifest.json
        echo '    "websiteUrl": "'${APP_URL}'",' >> manifest/manifest.json
        echo '    "privacyUrl": "'${APP_URL}'/manifest/privacy.html",' >> manifest/manifest.json
        echo '    "termsOfUseUrl": "'${APP_URL}'/manifest/terms.html"' >> manifest/manifest.json
        echo '  },' >> manifest/manifest.json
        echo '  "name": {' >> manifest/manifest.json
        echo '    "short": "GreenTeam",' >> manifest/manifest.json
        echo '    "full": "GreenTeam Kanban & Koledar"' >> manifest/manifest.json
        echo '  },' >> manifest/manifest.json
        echo '  "description": {' >> manifest/manifest.json
        echo '    "short": "Kanban in koledar za projektno vodenje",' >> manifest/manifest.json
        echo '    "full": "GreenTeam aplikacija za sledenje projektom in nalogam z integracijo kanban tablice, koledarja in dnevnikov aktivnosti."' >> manifest/manifest.json
        echo '  },' >> manifest/manifest.json
        echo '  "icons": {' >> manifest/manifest.json
        echo '    "outline": "icon-outline.png",' >> manifest/manifest.json
        echo '    "color": "icon-color.png"' >> manifest/manifest.json
        echo '  },' >> manifest/manifest.json
        echo '  "accentColor": "#00A76D",' >> manifest/manifest.json
        echo '  "staticTabs": [' >> manifest/manifest.json
        echo '    {' >> manifest/manifest.json
        echo '      "entityId": "greenteam-kanban",' >> manifest/manifest.json
        echo '      "name": "GreenTeam",' >> manifest/manifest.json
        echo '      "contentUrl": "'${APP_URL}'",' >> manifest/manifest.json
        echo '      "websiteUrl": "'${APP_URL}'",' >> manifest/manifest.json
        echo '      "scopes": ["personal"]' >> manifest/manifest.json
        echo '    }' >> manifest/manifest.json
        echo '  ],' >> manifest/manifest.json
        echo '  "permissions": ["identity"],' >> manifest/manifest.json
        echo '  "validDomains": [' >> manifest/manifest.json
        echo '    "*.github.io",' >> manifest/manifest.json
        echo '    "*.firebaseapp.com",' >> manifest/manifest.json
        echo '    "*.firebaseio.com",' >> manifest/manifest.json
        echo '    "*.googleapis.com"' >> manifest/manifest.json
        echo '  ]' >> manifest/manifest.json
        echo '}' >> manifest/manifest.json
        
        echo "‚úÖ Manifest.json ustvarjen"
        
        # Ustvari privacy.html ƒçe ne obstaja
        if [ ! -f "manifest/privacy.html" ]; then
          echo "üìù Ustvarjam privacy.html..."
          cat > manifest/privacy.html << 'EOF'
<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Politika zasebnosti - GreenTeam</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { color: #00a76d; }
        h2 { color: #333; margin-top: 30px; }
    </style>
</head>
<body>
    <h1>Politika zasebnosti za GreenTeam</h1>
    
    <p><strong>Zadnja posodobitev:</strong> $(date +'%d. %m. %Y')</p>
    
    <h2>1. Uvod</h2>
    <p>GreenTeam je odprtokodna aplikacija za upravljanje projektov, ki je na voljo brezplaƒçno. Ta politika zasebnosti pojasnjuje, kako ravnamo z va≈°imi podatki.</p>
    
    <h2>2. Podatki, ki jih zb√≠ramo</h2>
    <p>Aplikacija GreenTeam:</p>
    <ul>
        <li><strong>Ne zbira osebnih podatkov</strong> brez va≈°ega soglasja</li>
        <li>Vse naloge, projekti in dogodki so shranjeni v va≈°em brskalniku (localStorage) ali v Firebase za sinhronizacijo</li>
        <li>ƒåe uporabljate aplikacijo v Microsoft Teams, lahko vidite samo podatke, ki so vam dostopni v Teams</li>
    </ul>
    
    <h2>3. Firebase Storitev</h2>
    <p>Za sinhronizacijo podatkov med napravami uporabljamo Google Firebase. Firebase je varno okolje, ki uporablja ≈°ifriranje za vse podatke v prenosu.</p>
    <p>Firebase podatki so dostopni samo osebam, ki imajo dostop do va≈°ega Teams tima (ƒçe uporabljate Teams) ali samo vam (ƒçe uporabljate personal naƒçin).</p>
    
    <h2>4. Microsoft Teams Integracija</h2>
    <p>Ko uporabljate GreenTeam v Microsoft Teams:</p>
    <ul>
        <li>Vidite samo svoje ime iz Teams profila</li>
        <li>Aplikacija ne zbira dodatnih podatkov iz Teams</li>
        <li>Vsi podatki ostanejo znotraj va≈°e organizacije</li>
    </ul>
    
    <h2>5. Pi≈°kotki in sledenje</h2>
    <p>GreenTeam ne uporablja pi≈°kotkov za sledenje. Za delovanje aplikacije uporablja samo tehniƒçno potrebne shrambe podatkov v brskalniku.</p>
    
    <h2>6. Pravice uporabnikov</h2>
    <p>Kot uporabnik imate pravico do:</p>
    <ul>
        <li>Dostopa do svojih podatkov</li>
        <li>Brisanja svojih podatkov (izbri≈°ejo se z brisanjem localStorage ali Firebase podatkov)</li>
        <li>Uporabe aplikacije brez sledenja</li>
    </ul>
    
    <h2>7. Kontakt</h2>
    <p>Za vpra≈°anja o zasebnosti lahko ustvarite Issue na GitHub repozitoriju.</p>
    
    <h2>8. Spremembe politike</h2>
    <p>To politiko zasebnosti lahko posodabljamo. Spremembe bodo objavljene na tej strani.</p>
</body>
</html>
EOF
          echo "‚úÖ privacy.html ustvarjen"
        fi
        
        # Ustvari terms.html ƒçe ne obstaja
        if [ ! -f "manifest/terms.html" ]; then
          echo "üìù Ustvarjam terms.html..."
          cat > manifest/terms.html << 'EOF'
<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pogoji uporabe - GreenTeam</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { color: #00a76d; }
        h2 { color: #333; margin-top: 30px; }
    </style>
</head>
<body>
    <h1>Pogoji uporabe za GreenTeam</h1>
    
    <p><strong>Zadnja posodobitev:</strong> $(date +'%d. %m. %Y')</p>
    
    <h2>1. Sprejem pogojev</h2>
    <p>Z uporabo aplikacije GreenTeam se strinjate s temi pogoji uporabe. ƒåe se ne strinjate, ne uporabljajte aplikacije.</p>
    
    <h2>2. Opis storitve</h2>
    <p>GreenTeam je brezplaƒçna, odprtokodna aplikacija za:</p>
    <ul>
        <li>Upravljanje projektov z Kanban tablico</li>
        <li>Koledar za dogodke in rojstne dneve</li>
        <li>Sinhronizacijo podatkov med napravami preko Firebase</li>
        <li>Integracijo z Microsoft Teams</li>
    </ul>
    
    <h2>3. Pravice uporabe</h2>
    <p>Dovoljenje za uporabo:</p>
    <ul>
        <li>GreenTeam je na voljo pod MIT licenco</li>
        <li>Uporabite lahko aplikacijo za osebne in poslovne namene</li>
        <li>Uporaba je brezplaƒçna</li>
        <li>Lahko modificirate kodo v skladu z MIT licenco</li>
    </ul>
    
    <h2>4. Odgovornost</h2>
    <p><strong>OPOZORILO:</strong> Aplikacija je na voljo "kot je" (AS IS) brez kakr≈°nih koli jamstev.</p>
    <ul>
        <li>Avtorji ne prevzemajo odgovornosti za izgubo podatkov</li>
        <li>Uporabnik je odgovoren za varnost svojih podatkov</li>
        <li>Priporoƒçamo redno varnostno kopiranje podatkov</li>
    </ul>
    
    <h2>5. Omejitve uporabe</h2>
    <p>Prepovedano je:</p>
    <ul>
        <li>Uporaba aplikacije za nezakonite namene</li>
        <li>Ogla≈°evanje ali predstavljanje aplikacije kot lastne</li>
        <li>Po≈°kodovanje ali onemogoƒçanje delovanja aplikacije</li>
    </ul>
    
    <h2>6. Spremembe aplikacije</h2>
    <p>GreenTeam se lahko kadarkoli spremeni brez predhodnega obvestila. Funkcionalnosti se lahko dodajajo ali odstranjujejo.</p>
    
    <h2>7. Prekinitev uporabe</h2>
    <p>Avtorji lahko kadarkoli prekinejo dostop do aplikacije, ƒçe uporabnik kr≈°i te pogoje.</p>
    
    <h2>8. Pravno obvestilo</h2>
    <p>GreenTeam je odprtokodni projekt. Za podporo in vpra≈°anja uporabite GitHub Issues.</p>
    
    <h2>9. Kontakt</h2>
    <p>Za vpra≈°anja glede pogojev uporabe ustvarite Issue na GitHub repozitoriju.</p>
</body>
</html>
EOF
          echo "‚úÖ terms.html ustvarjen"
        fi
        
        echo "üìã Vsebina manifest mape:"
        ls -la manifest/
    
    # 8. Kreiraj Teams package
    - name: Create Teams Package
      run: |
        echo "üì¶ Creating Teams package..."
        
        if [ -d "manifest" ]; then
          cd manifest
          zip -r ../teams-app-package.zip *
          cd ..
          echo "‚úÖ Teams package created"
          ls -lh teams-app-package.zip
        else
          echo "‚ùå No manifest folder - cannot create Teams package"
          exit 1
        fi
    
    # 9. Upload Teams package kao artifact
    - name: Upload Teams Package
      uses: actions/upload-artifact@v4
      with:
        name: teams-app-package
        path: teams-app-package.zip
        retention-days: 7
    
    # 10. Deploy na GitHub Pages
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        keep_files: true
        force_orphan: false
    
    # 11. Success message
    - name: Success Notification
      run: |
        echo "üéâ Deployment successful!"
        echo "üåê App URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo "üì¶ Teams package available in Artifacts"
        echo ""
        echo "üìã Next steps:"
        echo "1. Create Firebase project: https://console.firebase.google.com/"
        echo "2. Add Web app and copy configuration"
        echo "3. Add configuration to GitHub Secrets:"
        echo "   - FIREBASE_API_KEY"
        echo "   - FIREBASE_AUTH_DOMAIN"
        echo "   - FIREBASE_PROJECT_ID"
        echo "   - FIREBASE_STORAGE_BUCKET"
        echo "   - FIREBASE_SENDER_ID"
        echo "   - FIREBASE_APP_ID"
        echo "4. Download teams-app-package.zip from Artifacts"
        echo "5. Upload to Teams Developer Portal"
