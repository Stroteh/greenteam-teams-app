name: Deploy GreenTeam to GitHub Pages

on:
  # PokreÄ‡e se na svaki push u main branch
  push:
    branches: ["main"]
  
  # RuÄno pokretanje
  workflow_dispatch:

# Dozvoli ovom workflow-u da piÅ¡e u repozitorij (za GitHub Pages)
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout koda
    - name: Checkout repository
      uses: actions/checkout@v4
    
    # 2. Setup Node.js (za eventualne build alate)
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    # 3. Kreiraj Firebase config datoteku
    - name: Generate Firebase Configuration
      run: |
        echo "ðŸš€ Generating firebase-config.js from GitHub Secrets..."
        
        # Kreiraj firebase-config.js
        cat > firebase-config.js << 'EOF'
        // ============================================
        // FIREBASE CONFIGURATION
        // Auto-generated by GitHub Actions
        // ============================================
        
        window.firebaseConfig = {
          apiKey: "${{ secrets.FIREBASE_API_KEY }}",
          authDomain: "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
          projectId: "${{ secrets.FIREBASE_PROJECT_ID }}",
          storageBucket: "${{ secrets.FIREBASE_STORAGE_BUCKET }}",
          messagingSenderId: "${{ secrets.FIREBASE_SENDER_ID }}",
          appId: "${{ secrets.FIREBASE_APP_ID }}"
        };
        
        console.log("ðŸ”¥ Firebase configuration loaded from GitHub Actions");
        EOF
        
        # PrikaÅ¾i preview (samo prvih 50 karaktera API key-a)
        echo "âœ… Generated firebase-config.js"
        echo "ðŸ“ Preview of apiKey: ${secrets.FIREBASE_API_KEY:0:50}..."
    
    # 4. Kreiraj Teams manifest package
    - name: Create Teams Package
      run: |
        echo "ðŸ“¦ Creating Teams app package..."
        
        # Koristi manifest folder
        cd manifest
        
        # Generiraj manifest.json sa pravim podacima
        cat > manifest.json << 'EOF'
        {
          "$schema": "https://developer.microsoft.com/en-us/json-schemas/teams/v1.16/MicrosoftTeams.schema.json",
          "manifestVersion": "1.16",
          "version": "1.0.0",
          "id": "${{ vars.TEAMS_APP_ID || 'a1b2c3d4-e5f6-7890-abcd-ef1234567890' }}",
          "packageName": "com.greenteam.kanban",
          "developer": {
            "name": "GreenTeam",
            "websiteUrl": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}",
            "privacyUrl": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/privacy.html",
            "termsOfUseUrl": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/terms.html"
          },
          "name": {
            "short": "GreenTeam",
            "full": "GreenTeam Kanban & Koledar"
          },
          "description": {
            "short": "Kanban in koledar za projektno vodenje",
            "full": "GreenTeam aplikacija za sledenje projektom in nalogam z integracijo kanban tablice, koledarja in dnevnikov aktivnosti."
          },
          "icons": {
            "outline": "icon-outline.png",
            "color": "icon-color.png"
          },
          "accentColor": "#00A76D",
          "staticTabs": [
            {
              "entityId": "greenteam-kanban",
              "name": "GreenTeam",
              "contentUrl": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}",
              "websiteUrl": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}",
              "scopes": ["personal"]
            }
          ],
          "permissions": ["identity", "messageTeamMembers"],
          "validDomains": [
            "${{ github.repository_owner }}.github.io",
            "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
            "*.googleapis.com"
          ]
        }
        EOF
        
        # Zip manifest folder
        zip -r ../teams-app-package.zip *
        cd ..
        
        echo "âœ… Teams package created: teams-app-package.zip"
    
    # 5. Upload Teams package kao artifact
    - name: Upload Teams Package
      uses: actions/upload-artifact@v4
      with:
        name: teams-app-package
        path: teams-app-package.zip
        retention-days: 7
    
    # 6. Deploy na GitHub Pages
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        keep_files: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
    
    # 7. PrikaÅ¾i success poruku
    - name: Success Notification
      run: |
        echo "ðŸŽ‰ Deployment successful!"
        echo "ðŸŒ Your app is live at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo "ðŸ“¦ Teams package: teams-app-package.zip (download from Artifacts)"
