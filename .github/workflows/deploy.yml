name: Deploy GreenTeam to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    # 1. Checkout koda
    - name: Checkout repository
      uses: actions/checkout@v4
    
    # 2. Preveri osnovne datoteke
    - name: Check basic files
      run: |
        echo "ğŸ“ Checking repository structure..."
        ls -la
        
        required_files=("index.html" "style.css")
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file exists"
          else
            echo "âŒ $file is missing!"
            echo "Creating placeholder $file..."
            if [ "$file" == "index.html" ]; then
              echo '<!DOCTYPE html><html><head><title>GreenTeam</title><link rel="stylesheet" href="style.css"></head><body><h1>GreenTeam App</h1><p>App is being deployed...</p></body></html>' > index.html
            elif [ "$file" == "style.css" ]; then
              echo 'body { font-family: Arial, sans-serif; padding: 20px; } h1 { color: #00a76d; }' > style.css
            fi
          fi
        done
    
    # 3. Ustvari manjkajoÄe JavaScript datoteke
    - name: Create missing JS files
      run: |
        # Ustvari teams-integration.js
        if [ ! -f "teams-integration.js" ]; then
          echo "// teams-integration.js - placeholder" > teams-integration.js
          echo "console.log('Teams integration loaded');" >> teams-integration.js
          echo "const teamsIntegration = { initialize: () => Promise.resolve(true) };" >> teams-integration.js
        fi
        
        # Ustvari firebase-service.js
        if [ ! -f "firebase-service.js" ]; then
          echo "// firebase-service.js - placeholder" > firebase-service.js
          echo "console.log('Firebase service loaded');" >> firebase-service.js
        fi
        
        # Ustvari funkcije.js
        if [ ! -f "funkcije.js" ]; then
          echo "// funkcije.js - placeholder" > funkcije.js
          echo "console.log('Main functions loaded');" >> funkcije.js
        fi
        
        # Ustvari firebase-config.js iz secretov
        echo "// Firebase Configuration" > firebase-config.js
        echo "window.firebaseConfig = {" >> firebase-config.js
        echo "  apiKey: '${{ secrets.FIREBASE_API_KEY || 'demo-key' }}'," >> firebase-config.js
        echo "  authDomain: '${{ secrets.FIREBASE_AUTH_DOMAIN || 'demo.firebaseapp.com' }}'," >> firebase-config.js
        echo "  projectId: '${{ secrets.FIREBASE_PROJECT_ID || 'demo-project' }}'," >> firebase-config.js
        echo "  storageBucket: '${{ secrets.FIREBASE_STORAGE_BUCKET || 'demo.appspot.com' }}'," >> firebase-config.js
        echo "  messagingSenderId: '${{ secrets.FIREBASE_SENDER_ID || '123456' }}'," >> firebase-config.js
        echo "  appId: '${{ secrets.FIREBASE_APP_ID || '1:123:web:abc' }}'" >> firebase-config.js
        echo "};" >> firebase-config.js
    
    # 4. Ustvari manifest mapo Äe ne obstaja
    - name: Create manifest directory
      run: |
        if [ ! -d "manifest" ]; then
          mkdir -p manifest
        fi
        
        # Ustvari preproste ikone
        if [ ! -f "manifest/icon-color.png" ]; then
          echo "iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAMAAABlApw1AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAADNQTFRF////AP//AAD/AAAA/wD//wAAAP//zP//mf//Zv//M///AABm//+Z//8z//8A//8AzP//mf//Zv8RNQxVAAABPUlEQVR42uzBgQAAAADDoPlT3+AEVQEAAADgs7YAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQIECBAgQIAAAQK8GgYAAAD9SURBVHja7MEBDQAACMOg+Tfd2BmCKgAAAAAAAAAAAAC+AWsAAAAASUVORK5CYII=" | base64 -d > manifest/icon-color.png 2>/dev/null || true
        fi
        
        if [ ! -f "manifest/icon-outline.png" ]; then
          echo "iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAADPSURBVFhH7ZZBCsJAEET7/y8VvUjeIHgQPXjw5M2L4E3ElYV0mtmd7Gwmk0wo+KiQdHd1z2YnKf6BZVnGdV2f67o+13V9ruv6XNf1ua7rc13X57quz3Vdn+u6Ptd1fa7r+lzX9bmu63Nd1+e6rs91XZ/ruj7XdX2u6/pc1/W5rutr3Zt0nuchO6r8gnEcz3Ecx3Ecx3Ecx3Ecx3Ecx3Ecx3Ecx3Ecx3Ecx3Ecx3Ecx3Ecx3Ecx3Ecx3Ecx3Ecx3Ecx3Ecx3Ecx3Ecx3Ecx3Ecx3Ecx3HcX3cPBWYAGU+2qEMAAAAASUVORK5CYII=" | base64 -d > manifest/icon-outline.png 2>/dev/null || true
        fi
    
    # 5. Deploy na GitHub Pages
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        force_orphan: false
        keep_files: true
    
    # 6. Success
    - name: Success
      run: |
        echo "ğŸ‰ Deployment successful!"
        echo "ğŸŒ Your app is available at:"
        echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo ""
        echo "ğŸ“‹ For full functionality:"
        echo "1. Add Firebase secrets in Settings â†’ Secrets and variables â†’ Actions"
        echo "2. Add: FIREBASE_API_KEY, FIREBASE_AUTH_DOMAIN, FIREBASE_PROJECT_ID, etc."
        echo "3. Push again to update with real Firebase config"
