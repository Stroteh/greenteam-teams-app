name: Deploy GreenTeam to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout koda
    - name: Checkout repository
      uses: actions/checkout@v4
    
    # 2. Setup Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    # 3. List files for debugging
    - name: Debug - List files
      run: |
        echo "ğŸ“ Repository structure:"
        find . -type f -name "*.js" -o -name "*.html" -o -name "*.css" | head -20
    
    # 4. Kreiraj Firebase config datoteku (JEDNOSTAVNIJE!)
    - name: Generate Firebase Configuration
      run: |
        echo "ğŸš€ Generating firebase-config.js..."
        
        # Kreiraj firebase-config.js koristeÄ‡i echo
        # OVAKO JE SIGURNIJE NEGO S HERE-DOC
        echo "// ============================================" > firebase-config.js
        echo "// FIREBASE CONFIGURATION" >> firebase-config.js
        echo "// Auto-generated by GitHub Actions" >> firebase-config.js
        echo "// ============================================" >> firebase-config.js
        echo "" >> firebase-config.js
        echo "window.firebaseConfig = {" >> firebase-config.js
        echo "  apiKey: '${{ secrets.FIREBASE_API_KEY }}'," >> firebase-config.js
        echo "  authDomain: '${{ secrets.FIREBASE_AUTH_DOMAIN }}'," >> firebase-config.js
        echo "  projectId: '${{ secrets.FIREBASE_PROJECT_ID }}'," >> firebase-config.js
        echo "  storageBucket: '${{ secrets.FIREBASE_STORAGE_BUCKET }}'," >> firebase-config.js
        echo "  messagingSenderId: '${{ secrets.FIREBASE_SENDER_ID }}'," >> firebase-config.js
        echo "  appId: '${{ secrets.FIREBASE_APP_ID }}'" >> firebase-config.js
        echo "};" >> firebase-config.js
        echo "" >> firebase-config.js
        echo "console.log('ğŸ”¥ Firebase configuration loaded from GitHub Actions');" >> firebase-config.js
        
        echo "âœ… firebase-config.js created"
        echo "ğŸ“„ First few lines:"
        head -10 firebase-config.js
    
    # 5. Provjeri manifest folder (JEDNOSTAVNIJE!)
    - name: Check or create manifest
      run: |
        echo "ğŸ“ Checking for manifest folder..."
        
        if [ -d "manifest" ]; then
          echo "âœ… Manifest folder exists"
          echo "ğŸ“‹ Manifest contents:"
          ls -la manifest/
        else
          echo "âš ï¸ Manifest folder not found"
          echo "ğŸ“ Creating minimal manifest files..."
          
          # Kreiraj manifest folder
          mkdir -p manifest
          
          # Download placeholder icons using wget (viÅ¡e pouzdano od curl -L)
          wget -q -O manifest/icon-outline.png "https://via.placeholder.com/32/00a76d/FFFFFF?text=GT" || true
          wget -q -O manifest/icon-color.png "https://via.placeholder.com/192/00a76d/FFFFFF?text=GT" || true
          
          # Kreiraj manifest.json s jednostavnim echo
          echo "{" > manifest/manifest.json
          echo '  "$schema": "https://developer.microsoft.com/en-us/json-schemas/teams/v1.16/MicrosoftTeams.schema.json",' >> manifest/manifest.json
          echo '  "manifestVersion": "1.16",' >> manifest/manifest.json
          echo '  "version": "1.0.0",' >> manifest/manifest.json
          echo '  "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",' >> manifest/manifest.json
          echo '  "packageName": "com.greenteam.kanban",' >> manifest/manifest.json
          echo '  "developer": {' >> manifest/manifest.json
          echo '    "name": "GreenTeam",' >> manifest/manifest.json
          echo '    "websiteUrl": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}",' >> manifest/manifest.json
          echo '    "privacyUrl": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/privacy.html",' >> manifest/manifest.json
          echo '    "termsOfUseUrl": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/terms.html"' >> manifest/manifest.json
          echo '  },' >> manifest/manifest.json
          echo '  "name": {' >> manifest/manifest.json
          echo '    "short": "GreenTeam",' >> manifest/manifest.json
          echo '    "full": "GreenTeam Kanban"' >> manifest/manifest.json
          echo '  },' >> manifest/manifest.json
          echo '  "description": {' >> manifest/manifest.json
          echo '    "short": "Kanban board",' >> manifest/manifest.json
          echo '    "full": "Kanban board and calendar for Teams"' >> manifest/manifest.json
          echo '  },' >> manifest/manifest.json
          echo '  "icons": {' >> manifest/manifest.json
          echo '    "outline": "icon-outline.png",' >> manifest/manifest.json
          echo '    "color": "icon-color.png"' >> manifest/manifest.json
          echo '  },' >> manifest/manifest.json
          echo '  "accentColor": "#00A76D",' >> manifest/manifest.json
          echo '  "staticTabs": [' >> manifest/manifest.json
          echo '    {' >> manifest/manifest.json
          echo '      "entityId": "greenteam-kanban",' >> manifest/manifest.json
          echo '      "name": "GreenTeam",' >> manifest/manifest.json
          echo '      "contentUrl": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}",' >> manifest/manifest.json
          echo '      "websiteUrl": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}",' >> manifest/manifest.json
          echo '      "scopes": ["personal"]' >> manifest/manifest.json
          echo '    }' >> manifest/manifest.json
          echo '  ],' >> manifest/manifest.json
          echo '  "permissions": ["identity"],' >> manifest/manifest.json
          echo '  "validDomains": [' >> manifest/manifest.json
          echo '    "${{ github.repository_owner }}.github.io",' >> manifest/manifest.json
          echo '    "*.googleapis.com"' >> manifest/manifest.json
          echo '  ]' >> manifest/manifest.json
          echo '}' >> manifest/manifest.json
          
          echo "âœ… Created minimal manifest"
        fi
    
    # 6. Kreiraj Teams package
    - name: Create Teams Package
      run: |
        echo "ğŸ“¦ Creating Teams package..."
        
        if [ -d "manifest" ]; then
          cd manifest
          zip -r ../teams-app-package.zip *
          cd ..
          echo "âœ… Teams package created"
          ls -lh teams-app-package.zip
        else
          echo "âŒ No manifest folder - cannot create Teams package"
          exit 1
        fi
    
    # 7. Upload Teams package kao artifact
    - name: Upload Teams Package
      uses: actions/upload-artifact@v4
      with:
        name: teams-app-package
        path: teams-app-package.zip
        retention-days: 7
    
    # 8. Deploy na GitHub Pages
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        keep_files: true
        force_orphan: false
    
    # 9. Success message
    - name: Success Notification
      run: |
        echo "ğŸ‰ Deployment successful!"
        echo "ğŸŒ App URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo "ğŸ“¦ Teams package available in Artifacts"
