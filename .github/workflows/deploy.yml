name: Deploy GreenTeam to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    # 1. Checkout kod
    - name: Checkout repository
      uses: actions/checkout@v4
    
    # 2. Preveri da li postoje svi potrebni fajlovi
    - name: Check required files
      run: |
        echo "ðŸ“ Checking required files..."
        
        if [ ! -f "index.html" ]; then echo "âŒ index.html not found"; exit 1; else echo "âœ… index.html exists"; fi
        if [ ! -f "style.css" ]; then echo "âŒ style.css not found"; exit 1; else echo "âœ… style.css exists"; fi
        if [ ! -f "funkcije.js" ]; then echo "âŒ funkcije.js not found"; exit 1; else echo "âœ… funkcije.js exists"; fi
        if [ ! -f "teams-integration.js" ]; then echo "âŒ teams-integration.js not found"; exit 1; else echo "âœ… teams-integration.js exists"; fi
        if [ ! -f "firebase-service.js" ]; then echo "âŒ firebase-service.js not found"; exit 1; else echo "âœ… firebase-service.js exists"; fi
        if [ ! -f "firebase-config.js" ]; then echo "âŒ firebase-config.js not found"; exit 1; else echo "âœ… firebase-config.js exists"; fi
    
       # 3. Ustvari firebase-config.js iz GitHub Secrets
    - name: Create Firebase config from secrets
      run: |
        echo "ðŸ”§ Ustvarjam firebase-config.js iz GitHub Secrets..."
        
        cat > firebase-config.js << EOF
        // Firebase Configuration - Generated by GitHub Actions
        window.firebaseConfig = {
            apiKey: "${{ secrets.FIREBASE_API_KEY }}",
            authDomain: "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
            projectId: "${{ secrets.FIREBASE_PROJECT_ID }}",
            messagingSenderId: "${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}",
            appId: "${{ secrets.FIREBASE_APP_ID }}",
            storageBucket: "${{ secrets.FIREBASE_STORAGE_BUCKET}}",
        };
        
        console.log("âœ… Firebase konfiguracija naloÅ¾ena iz GitHub Secrets");
        EOF
        
        echo "âœ… firebase-config.js ustvarjen"
        echo "Preverjam prve vrstice:"
        head -5 firebase-config.js
        
        # Zamijeni placeholdere sa stvarnim vrijednostima
        # Za macOS/Linux kompatibilnost
        sed -i.bak "s|_FIREBASE_API_KEY_|${{ secrets.FIREBASE_API_KEY }}|g" firebase-config.js && rm firebase-config.js.bak
        sed -i.bak "s|_FIREBASE_AUTH_DOMAIN_|${{ secrets.FIREBASE_AUTH_DOMAIN }}|g" firebase-config.js && rm firebase-config.js.bak
        sed -i.bak "s|_FIREBASE_PROJECT_ID_|${{ secrets.FIREBASE_PROJECT_ID }}|g" firebase-config.js && rm firebase-config.js.bak
        sed -i.bak "s|_FIREBASE_SENDER_ID_|${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}|g" firebase-config.js && rm firebase-config.js.bak
        sed -i.bak "s|_FIREBASE_APP_ID_|${{ secrets.FIREBASE_APP_ID }}|g" firebase-config.js && rm firebase-config.js.bak
        sed -i.bak "s|_FIREBASE_STORAGE_BUCKET_|${{ secrets.FIREBASE_STORAGE_BUCKET }}|g" firebase-config.js && rm firebase-config.js.bak
        echo "âœ… Firebase config updated with secrets"
        echo "Updated firebase-config.js (first 5 lines):"
        head -5 firebase-config.js
    
    # 4. Setup GitHub Pages
    - name: Setup Pages
      uses: actions/configure-pages@v3
    
    # 5. Upload artifact (aÅ¾urirano na v3)
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    # 6. Deploy to GitHub Pages
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      with:
        timeout: 600000  # 10 minutes timeout
    
    # 7. Success message
    - name: Success
      run: |
        echo "ðŸŽ‰ Deployment successful!"
        echo "ðŸŒ Your app is available at:"
        echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        echo ""
        echo "ðŸ“‹ Deployment details:"
        echo "Environment: ${{ vars.ENVIRONMENT_NAME || 'github-pages' }}"
        echo "URL: ${{ steps.deployment.outputs.page_url }}"
