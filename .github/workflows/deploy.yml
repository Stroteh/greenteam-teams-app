name: Deploy GreenTeam to GitHub Pages

on:
  # PokreÄ‡e se na svaki push u main branch
  push:
    branches: ["main"]
  
  # RuÄno pokretanje
  workflow_dispatch:

# Dozvoli ovom workflow-u da piÅ¡e u repozitorij (za GitHub Pages)
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout koda
    - name: Checkout repository
      uses: actions/checkout@v4
    
    # 2. Setup Node.js (za eventualne build alate)
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    # 3. List files for debugging
    - name: List repository files
      run: ls -la
    
    # 4. Kreiraj Firebase config datoteku
    - name: Generate Firebase Configuration
      run: |
        echo "ðŸš€ Generating firebase-config.js from GitHub Secrets..."
        
        # Prvo provjeri postoje li Secrets
        echo "ðŸ” Checking for required secrets..."
        
        # Kreiraj firebase-config.js
        cat > firebase-config.js << 'EOF'
        // ============================================
        // FIREBASE CONFIGURATION
        // Auto-generated by GitHub Actions - DO NOT EDIT
        // ============================================
        
        window.firebaseConfig = {
          apiKey: "${{ secrets.FIREBASE_API_KEY }}",
          authDomain: "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
          projectId: "${{ secrets.FIREBASE_PROJECT_ID }}",
          storageBucket: "${{ secrets.FIREBASE_STORAGE_BUCKET }}",
          messagingSenderId: "${{ secrets.FIREBASE_SENDER_ID }}",
          appId: "${{ secrets.FIREBASE_APP_ID }}"
        };
        
        console.log("ðŸ”¥ Firebase configuration loaded from GitHub Actions");
        EOF
        
        # PrikaÅ¾i preview (bez prikazivanja cijelog kljuÄa)
        echo "âœ… Generated firebase-config.js"
        echo "ðŸ“ Config saved successfully"
    
    # 5. Provjeri da li postoji manifest folder
    - name: Check manifest folder
      run: |
        echo "ðŸ“ Checking manifest folder..."
        if [ ! -d "manifest" ]; then
          echo "âŒ Manifest folder not found! Creating placeholder..."
          mkdir -p manifest
          
          # Download placeholder icons
          curl -L -o manifest/icon-outline.png "https://via.placeholder.com/32/00a76d/FFFFFF?text=GT"
          curl -L -o manifest/icon-color.png "https://via.placeholder.com/192/00a76d/FFFFFF?text=GT"
          
          # Create minimal manifest
          cat > manifest/manifest.json << 'EOF'
          {
            "$schema": "https://developer.microsoft.com/en-us/json-schemas/teams/v1.16/MicrosoftTeams.schema.json",
            "manifestVersion": "1.16",
            "version": "1.0.0",
            "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
            "packageName": "com.greenteam.kanban",
            "developer": {
              "name": "GreenTeam",
              "websiteUrl": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
            },
            "name": { "short": "GreenTeam" },
            "description": { "short": "Kanban board for Teams" },
            "icons": {
              "outline": "icon-outline.png",
              "color": "icon-color.png"
            },
            "accentColor": "#00A76D",
            "staticTabs": [
              {
                "entityId": "greenteam-kanban",
                "name": "GreenTeam",
                "contentUrl": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}",
                "websiteUrl": "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}",
                "scopes": ["personal"]
              }
            ],
            "permissions": ["identity"],
            "validDomains": ["*.github.io"]
          }
          EOF
        else
          echo "âœ… Manifest folder exists"
        fi
    
    # 6. Kreiraj Teams package (samo ako manifest folder postoji)
    - name: Create Teams Package
      if: success()
      run: |
        echo "ðŸ“¦ Creating Teams app package..."
        
        if [ -d "manifest" ]; then
          cd manifest
          zip -r ../teams-app-package.zip *
          cd ..
          echo "âœ… Teams package created: teams-app-package.zip"
        else
          echo "âš ï¸ Skipping Teams package - manifest folder not found"
        fi
    
    # 7. Deploy na GitHub Pages
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        keep_files: true
        force_orphan: false
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
    
    # 8. Success message
    - name: Success Notification
      run: |
        echo "ðŸŽ‰ Deployment successful!"
        echo "ðŸŒ Your app is live at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        if [ -f "teams-app-package.zip" ]; then
          echo "ðŸ“¦ Teams package: teams-app-package.zip"
        fi
